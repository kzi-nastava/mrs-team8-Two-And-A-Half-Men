import{a as U}from"./chunk-6HEX5QYM.js";import{u as $}from"./chunk-OXPWAMAC.js";import{b as A}from"./chunk-5IMUJISG.js";import{Ac as z,Gb as E,Ha as a,Hb as p,Ib as w,Jb as T,K as S,P as g,U as d,V as l,Va as y,Xb as L,aa as u,eb as f,fa as b,fb as C,ga as O,ib as k,jb as P,m as h,ob as s,pb as r,sc as R,ub as M,vb as I,xb as m,yb as c}from"./chunk-GHGVHUHC.js";import{a as x,b as _,g as v}from"./chunk-TSRGIXR5.js";var N=(o,e)=>e.id;function j(o,e){if(o&1){let t=M();s(0,"button",11),m("click",function(){d(t);let i=c(2);return l(i.onMinimize())}),p(1,"\u2212"),r()}}function H(o,e){o&1&&(s(0,"div",13),p(1,"\u2713"),r())}function q(o,e){if(o&1&&(s(0,"div")(1,"div",12),f(2,H,2,0,"div",13),p(3),s(4,"span",14),p(5),r()()()),o&2){let t=e.$implicit,n=c(2);E("message "+(n.isOwnMessage(t)?"own-message":"other-message")),a(2),C(n.isRead(t)?2:-1),a(),T(" ",t.content," "),a(2),w(n.formatTime(t.timestamp))}}function B(o,e){if(o&1){let t=M();s(0,"div",0)(1,"div",1)(2,"span",2),p(3),r(),s(4,"div",3),f(5,j,2,0,"button",4),s(6,"button",5),m("click",function(){d(t);let i=c();return l(i.onClose())}),p(7,"\xD7"),r()()(),s(8,"div",6),k(9,q,6,5,"div",7,N),r(),s(11,"div",8)(12,"input",9),m("input",function(i){d(t);let V=c();return l(V.newMessage.set(i.target.value))})("keyup.enter",function(){d(t);let i=c();return l(i.onSend())}),r(),s(13,"button",10),m("click",function(){d(t);let i=c();return l(i.onSend())}),p(14,"Send"),r()()()}if(o&2){let t=c();a(3),w(t.title),a(2),C(t.isMinimizable?5:-1),a(4),P(t.chat.messages),a(3),I("value",t.newMessage())}}var D=class o{chat;title="Live support";isOpen=!0;isMinimizable=!1;userId=-1;isOpenChange=new u;minimize=new u;close=new u;messageSend=new u;newMessage=b("");onSend(){let e=this.newMessage().trim();e&&(this.messageSend.emit(e),this.newMessage.set(""))}onMinimize(){this.minimize.emit()}onClose(){this.isOpen=!1,this.isOpenChange.emit(!1),this.close.emit()}isOwnMessage(e){return e.senderId===this.userId}formatTime(e){let t=new Date(e),n=t.getHours().toString().padStart(2,"0"),i=t.getMinutes().toString().padStart(2,"0");return`${n}:${i}`}scrollToBottom(){let e=document.querySelector(".chat-messages");e&&(e.scrollTop=e.scrollHeight)}isRead(e){if(!this.isOwnMessage(e))return!1;switch(e.senderType){case"ADMIN":return e.userRead;case"DRIVER":case"CUSTOMER":return e.adminRead;default:return!1}}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=y({type:o,selectors:[["app-chat-window"]],inputs:{chat:"chat",title:"title",isOpen:"isOpen",isMinimizable:"isMinimizable",userId:"userId"},outputs:{isOpenChange:"isOpenChange",minimize:"minimize",close:"close",messageSend:"messageSend"},decls:1,vars:1,consts:[[1,"chat-container"],[1,"chat-header"],[1,"chat-title"],[1,"chat-actions"],["title","Minimize",1,"action-btn"],["title","Close",1,"action-btn",3,"click"],[1,"chat-messages"],[3,"class"],[1,"chat-input-container"],["type","text","placeholder","Type text...",1,"chat-input",3,"input","keyup.enter","value"],[1,"send-btn",3,"click"],["title","Minimize",1,"action-btn",3,"click"],[1,"message-content"],[1,"checkmark"],[1,"message-time"]],template:function(t,n){t&1&&f(0,B,15,3,"div",0),t&2&&C(n.isOpen?0:-1)},dependencies:[R,$],styles:[".chat-container[_ngcontent-%COMP%]{position:fixed;bottom:20px;right:20px;width:360px;height:500px;background:#2b2b2b;border-radius:8px;box-shadow:0 4px 20px #0000004d;display:flex;flex-direction:column;font-family:Arial,sans-serif;z-index:1000}.chat-header[_ngcontent-%COMP%]{background:#1a5c3a;color:#fff;padding:12px 16px;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center}.chat-title[_ngcontent-%COMP%]{font-weight:600;font-size:14px}.chat-actions[_ngcontent-%COMP%]{display:flex;gap:8px}.action-btn[_ngcontent-%COMP%]{background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center;transition:opacity .2s}.action-btn[_ngcontent-%COMP%]:hover{opacity:.7}.chat-messages[_ngcontent-%COMP%]{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:8px}.chat-messages[_ngcontent-%COMP%]::-webkit-scrollbar{width:6px}.chat-messages[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:#1f1f1f}.chat-messages[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:#444;border-radius:3px}.loading-indicator[_ngcontent-%COMP%]{text-align:center;color:#888;padding:20px}.message[_ngcontent-%COMP%]{display:flex;margin-bottom:4px}.own-message[_ngcontent-%COMP%]{justify-content:flex-end}.other-message[_ngcontent-%COMP%]{justify-content:flex-start}.message-content[_ngcontent-%COMP%]{max-width:75%;padding:10px 14px;border-radius:8px;position:relative;word-wrap:break-word;font-size:13px;line-height:1.4}.own-message[_ngcontent-%COMP%]   .message-content[_ngcontent-%COMP%]{background:#1a5c3a;color:#fff}.other-message[_ngcontent-%COMP%]   .message-content[_ngcontent-%COMP%]{background:#5a4a2a;color:#fff}.checkmark[_ngcontent-%COMP%]{position:absolute;left:-20px;top:50%;transform:translateY(-50%);color:#1a5c3a;font-size:14px}.message-time[_ngcontent-%COMP%]{font-size:10px;opacity:.7;margin-left:8px;white-space:nowrap}.chat-input-container[_ngcontent-%COMP%]{padding:16px;border-top:1px solid #3a3a3a;display:flex;gap:8px}.chat-input[_ngcontent-%COMP%]{flex:1;background:transparent;border:1px solid #4a4a4a;border-radius:4px;padding:10px 12px;color:#fff;font-size:13px}.chat-input[_ngcontent-%COMP%]::placeholder{color:#888}.chat-input[_ngcontent-%COMP%]:focus{outline:none;border-color:#1a5c3a}.send-btn[_ngcontent-%COMP%]{background:#1a5c3a;color:#fff;border:none;border-radius:4px;padding:10px 24px;cursor:pointer;font-size:13px;font-weight:600;transition:background .2s}.send-btn[_ngcontent-%COMP%]:hover{background:#236b48}.send-btn[_ngcontent-%COMP%]:active{background:#154a30}"]})};var F=class o{API_URL="/api/v1/support";http=g(z);webSocketService=g(U);authService=g(A);chats=b([]);myChat=L(()=>this.chats().length>0?this.chats()[0]:null);unsubscribeFn=null;subscribedUserId=null;constructor(){this.setupLiveSupportSubscription()}setupLiveSupportSubscription(){O(()=>{let e=this.authService.user();if(!e){this.subscribedUserId!==null&&(this.unsubscribeFromLiveSupport(),this.chats.set([]),this.subscribedUserId=null);return}this.subscribedUserId!==e.id&&(this.subscribedUserId=e.id,e.role==="ADMIN"?(this.subscribeToAdminSupport(),this.getAllActiveChats().subscribe({next:t=>{this.chats.set(t)},error:t=>{console.error("[ChatService] Error loading admin chats:",t)}})):(this.subscribeToUserSupport(e.id).then(),this.getMyChat().subscribe({next:t=>{this.chats.set([t])},error:t=>{console.error("[ChatService] Error loading user chat:",t)}})))})}subscribeToAdminSupport(){return v(this,null,function*(){this.unsubscribeFromLiveSupport();try{this.unsubscribeFn=yield this.webSocketService.subscribe("/topic/support/admin",e=>this.handleNewMessage(e))}catch(e){console.error("[ChatService] Error subscribing to live support:",e)}})}subscribeToUserSupport(e){return v(this,null,function*(){this.unsubscribeFromLiveSupport();try{this.unsubscribeFn=yield this.webSocketService.subscribe(`/topic/chat/${e}`,t=>this.handleNewMessage(t))}catch(t){console.error("[ChatService] Error subscribing to live support:",t)}})}handleNewMessage(e){console.log("[CharService] New message received:",e);let t=this.chats().findIndex(n=>n.id===e.chatId);if(t===-1){this.getChatById(e.chatId).subscribe({next:n=>{this.chats.update(i=>[...i,n])},error:n=>{console.error(`[ChatService] Error fetching chat ${e.chatId}:`,n)}});return}this.chats.update(n=>{let i=[...n];return i[t]=_(x({},i[t]),{messages:[...i[t].messages,e]}),i})}unsubscribeFromLiveSupport(){this.unsubscribeFn&&(console.log("[NotificationService] Unsubscribing from notifications"),this.unsubscribeFn(),this.unsubscribeFn=null)}getMyChat(){return this.http.get(`${this.API_URL}/my-chat`)}getAllActiveChats(){return this.http.get(`${this.API_URL}/chats`).pipe(h(e=>e.map(t=>t)))}getChatById(e){return this.http.get(`${this.API_URL}/chats/${e}`)}getChatMessages(e){return this.http.get(`${this.API_URL}/chats/${e}/messages`).pipe(h(t=>t.map(n=>this.convertMessageDates(n))))}sendMessage(e,t){let n={content:t};return this.http.post(`${this.API_URL}/chats/${e}/messages`,n).pipe(h(i=>this.convertMessageDates(i)))}markMessagesAsRead(e){return this.http.put(`${this.API_URL}/chats/${e}/mark-read`,{})}closeChat(e){return this.http.put(`${this.API_URL}/chats/${e}/close`,{})}reopenChat(e){return this.http.put(`${this.API_URL}/chats/${e}/reopen`,{})}convertMessageDates(e){return _(x({},e),{timestamp:new Date(e.timestamp)})}static \u0275fac=function(t){return new(t||o)};static \u0275prov=S({token:o,factory:o.\u0275fac,providedIn:"root"})};export{D as a,F as b};
