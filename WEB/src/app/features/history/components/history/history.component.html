<div class="ride-history-container">
	<div class="history-header">
		<h2>Ride History</h2>

		<div class="history-controls">
			<!-- Sort Field Dropdown -->
			<select
				class="sort-field-select"
				[value]="sortField()"
				(change)="onSortFieldChange($any($event.target).value)"
			>
				@for (option of sortOptions(); track option.field) {
					<option [value]="option.field">{{ option.label }}</option>
				}
			</select>

			<!-- Sort Direction Button -->
			<button class="btn-sort" (click)="toggleSortDirection()">
				@if (sortDirection() === 'ASC') {
					‚Üë Ascending
				} @else {
					‚Üì Descending
				}
			</button>

			<!-- Filter Toggle Button -->
			<button class="btn-filter" (click)="toggleFilters()">
				üîç Filters
				@if (showFilters()) {
					‚ñ≤
				} @else {
					‚ñº
				}
			</button>
		</div>
	</div>

	<!-- Filters Panel -->
	@if (showFilters()) {
		<div class="filters-panel">
			<div class="filter-group">
				<label for="startDate">Start Date:</label>
				<input
					type="date"
					id="startDate"
					[(ngModel)]="filterStartDate"
					class="date-input"
				/>
			</div>

			<div class="filter-group">
				<label for="endDate">End Date:</label>
				<input
					type="date"
					id="endDate"
					[(ngModel)]="filterEndDate"
					class="date-input"
				/>
			</div>

			<div class="filter-actions">
				<button class="btn-apply" (click)="applyFilters()">
					Apply Filters
				</button>
				<button class="btn-clear" (click)="clearFilters()">
					Clear Filters
				</button>
			</div>
		</div>
	}

	@if (loading()) {
		<div class="loading-spinner">
			<div class="spinner"></div>
			<p>Loading...</p>
		</div>
	}

	@if (!loading()) {
		<div class="rides-list">
			@if (rides().length === 0) {
				<div class="no-rides">
					<p>There are no rides in history</p>
				</div>
			}

			@for (ride of rides(); track ride.id) {
				<div
					class="ride-card"
					[class.clickable]="config().canViewDetails"
					(click)="onRideClick(ride)"
				>
					<!-- Status badge -->
					<div class="ride-header">
                        <span class="status-badge" [ngClass]="getStatusClass(ride.status)">
                            {{ getStatusText(ride.status) }}
                        </span>
						@if (ride.status === RideStatus.PANICKED && config().showPanicButton) {
							<span class="panic-indicator">‚ö†Ô∏è</span>
						}
					</div>

					<!-- BASIC INFO -->
					<div class="ride-info">
						<div class="info-row">
							<span class="label">Start point:</span>
							<span class="value">{{ ride.addresses[0] }}</span>
						</div>
						<div class="info-row">
							<span class="label">Destination:</span>
							<span class="value">{{
									ride.addresses[ride.addresses.length - 1]
								}}</span>
						</div>

						@if (ride.startTime) {
							<div class="info-row">
								<span class="label">Start time:</span>
								<span class="value">{{ formatDate(ride.startTime) }}</span>
							</div>
						}

						@if (ride.endTime) {
							<div class="info-row">
								<span class="label">End time:</span>
								<span class="value">{{ formatDate(ride.endTime) }}</span>
							</div>
						}

						<div class="info-row">
							<span class="label">Total cost:</span>
							<span class="value price">{{ ride.totalCost }} RSD</span>
						</div>

						<!-- DRIVER INFO -->
						@if (config().showDriverInfo) {
							<div class="info-row">
								<span class="label">Driver:</span>
								<span class="value">{{ ride.driverName }}</span>
							</div>
						}

						<!-- PASSENGER INFO -->
						@if (config().showPassengerInfo) {
							<div class="info-row">
								<span class="label">Ride owner:</span>
								<span class="value">{{ ride.rideOwnerName }}</span>
							</div>
							<div class="info-row">
								<span class="label">Passengers:</span>
								<div class="passengers-list">
									@for (passenger of ride.passengersMails; track passenger) {
										<span class="passenger-email">{{ passenger }}</span>
									}
								</div>
							</div>
						}

						<!-- Cancellation reason -->
						@if (ride.status === RideStatus.CANCELLED && ride.cancellationReason) {
							<div class="info-row cancellation">
								<span class="label">Cancellation reason:</span>
								<span class="value">{{ ride.cancellationReason }}</span>
							</div>
						}

						<!-- Additional services -->
						@if (ride.additionalServices.length > 0) {
							<div class="info-row">
								<span class="label">Additional services:</span>
								<div class="services-list">
									@for (service of ride.additionalServices; track service) {
										<span class="service-tag">{{ service }}</span>
									}
								</div>
							</div>
						}
					</div>

					<!-- ACTIONS -->
					@if (config().showReorderOption && ride.status === RideStatus.FINISHED) {
						<div class="ride-actions">
							<button
								class="btn-reorder"
								(click)="onReorderNow(ride); $event.stopPropagation()"
							>
								Book now
							</button>
						</div>
					}
				</div>
			}
		</div>

		<!-- Pagination -->
		@if (totalElements() > 0) {
			<div class="pagination">
				<button
					class="btn-pagination"
					[disabled]="page() === 0"
					(click)="previousPage()"
				>
					Previous
				</button>

				<span class="pagination-info">
                    Page {{ page() + 1 }} of {{ Math.ceil(totalElements() / size()) }}
					({{ totalElements() }} total rides)
                </span>

				<button
					class="btn-pagination"
					[disabled]="(page() + 1) * size() >= totalElements()"
					(click)="nextPage()"
				>
					Next
				</button>

				<select
					class="page-size-select"
					[value]="size()"
					(change)="onPageSizeChange(+$any($event.target).value)"
				>
					@for (option of pageSizeOptions; track option) {
						<option [value]="option">{{ option }} per page</option>
					}
				</select>
			</div>
		}
	}
</div>
